/**
 * JavaScript for YouTube submission grading interface.
 *
 * @module    assignsubmission_ytsubmission/grading
 * @copyright 2025 Mathieu Pelletier <mathieu@sats.ac.za>
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/notification"],function(t,e,i){"use strict";var n=null,s=null,o=null,a=null,m=null,r=null,l=0,c=null,u=null,d=[],b={},y=!1,f=0,p=null;function v(){n=new YT.Player("ytsubmission-grading-player",{height:"360",width:"640",videoId:s,events:{onReady:g,onStateChange:h}})}function g(){l=n.getDuration(),k(),setInterval(w,500)}function h(){}function w(){if(n&&"function"==typeof n.getCurrentTime)try{l<=0&&"function"==typeof n.getDuration&&(l=n.getDuration())>0&&k();var t=Math.floor(n.getCurrentTime()),e=Math.floor(t/60),i=t%60,s=x(e)+":"+x(i);if(m&&(m.textContent=s),r&&(r.value=t),u&&l>0){var o=t/l,a=Math.min(Math.max(100*o,0),100);u.style.left=a+"%"}}catch(t){}}function x(t){return(t<10?"0":"")+t}function k(){c=document.getElementById("ytsubmission-timeline-container"),u=document.getElementById("ytsubmission-timeline-playhead"),!c||l<=0||(d.forEach(function(t){C(t)}),c.addEventListener("click",function(t){if(!t.target.classList.contains("ytsubmission-timeline-marker")){var e=c.getBoundingClientRect(),i=(t.clientX-e.left)/e.width,s=Math.floor(i*l);n&&"function"==typeof n.seekTo&&n.seekTo(s,!0)}}))}function C(t){if(c&&!(l<=0)){var e=t.timestamp/l,i=Math.min(Math.max(100*e,0),100),s=t.commenttype||"general",o=b[s]||b.general||{label:"General",color:"#6c757d"},a=document.createElement("div");a.className="ytsubmission-timeline-marker ytsubmission-timeline-marker-"+s,a.id="ytsubmission-timeline-marker-"+t.id,a.style.left=i+"%",a.style.backgroundColor=o.color,a.style.borderColor="#fff",a.setAttribute("data-timestamp",t.timestamp),a.setAttribute("data-commentid",t.id);var m=document.createElement("div");m.className="ytsubmission-timeline-tooltip",m.textContent="["+o.label+"] "+function(t){var e=Math.floor(t/3600),i=Math.floor(t%3600/60),n=t%60;if(e>0)return x(e)+":"+x(i)+":"+x(n);return x(i)+":"+x(n)}(t.timestamp)+" - "+t.comment,a.appendChild(m),a.addEventListener("click",function(e){e.stopPropagation(),n&&"function"==typeof n.seekTo&&(n.seekTo(t.timestamp,!0),n.playVideo())}),c.appendChild(a)}}function E(){var e="";if(window.tinymce){var i=window.tinymce.get("ytsubmission-comment-text");i&&(i.save(),e=i.getContent().trim())}return e||(e=t("#ytsubmission-comment-text").val().trim()),e}function T(){t("#ytsubmission-add-comment-btn").on("click",function(s){s.preventDefault();var m=E(),r=m.replace(/<[^>]*>/g,"").replace(/&nbsp;/g,"").trim(),l=parseInt(t("#ytsubmission-timestamp-input").val(),10),c=t("#ytsubmission-commenttype").val()||"general",u=parseInt(t("#ytsubmission-draftitemid").val(),10)||0;if(n&&"function"==typeof n.getCurrentTime)try{l=Math.floor(n.getCurrentTime())}catch(t){}r?e.call([{methodname:"assignsubmission_ytsubmission_add_comment",args:{submissionid:o,assignmentid:a,timestamp:l,comment:m,commenttype:c,draftitemid:u}}])[0].done(function(e){if(e.success){!function(){if(window.tinymce){var e=window.tinymce.get("ytsubmission-comment-text");e&&e.setContent("")}t("#ytsubmission-comment-text").val("")}(),t("#ytsubmission-timestamp-input").val("0"),t("#ytsubmission-commenttype").val("general"),t("#ytsubmission-draftitemid").val("0");var n=e.comment,s=t(function(t){var e=Math.floor(t.timestamp/3600),i=Math.floor(t.timestamp%3600/60),n=t.timestamp%60,s=(e>0?("0"+e).slice(-2)+":":"")+("0"+i).slice(-2)+":"+("0"+n).slice(-2),o=t.commenttype||"general",a=b[o]||b.general||{label:"General",color:"#6c757d"},m='<div class="ytsubmission-comment-item card mb-2" id="ytsubmission-comment-'+t.id+'">';m+='<div class="card-body">',m+='<div class="d-flex justify-content-between align-items-start">',m+='<div class="flex-grow-1">',m+='<a href="#" class="ytsubmission-timestamp-link badge text-white me-1 ytsubmission-badge-'+o+'" data-timestamp="'+t.timestamp+'" style="background-color:'+a.color+'">',m+='<i class="fa fa-clock-o"></i> '+s+"</a>",m+='<span class="badge me-2 ytsubmission-badge-'+o+'" style="background-color:'+a.color+';color:#fff;">'+a.label+"</span>",m+='<small class="text-muted">'+t.gradername+" - "+t.timecreated+"</small>",m+="</div>",y||(m+='<button class="btn btn-sm btn-danger ytsubmission-delete-comment" data-commentid="'+t.id+'">',m+='<i class="fa fa-trash"></i></button>');return m+="</div>",m+='<div class="mt-2 mb-0">'+t.comment+"</div>",m+="</div></div>"}(n)),o=t("#ytsubmission-comments-list");o.children("p.text-muted").length>0&&o.empty(),o.append(s),t("html, body").animate({scrollTop:s.offset().top-100},500),C({id:n.id,timestamp:n.timestamp,comment:n.comment.replace(/<[^>]*>/g,"").substring(0,80),commenttype:n.commenttype||"general",gradername:n.gradername}),s.hide().fadeIn(400)}else i.alert("Error",e.message||"Failed to add comment.","OK")}).fail(function(t){i.exception(t)}):i.alert("Error","Please enter a comment.","OK")})}function I(){t(document).on("click",".ytsubmission-delete-comment",function(n){n.preventDefault();var s=parseInt(t(this).data("commentid"),10),o=t("#ytsubmission-comment-"+s);confirm("Are you sure you want to delete this comment?")&&e.call([{methodname:"assignsubmission_ytsubmission_delete_comment",args:{commentid:s}}])[0].done(function(e){e.success?(!function(t){var e=document.getElementById("ytsubmission-timeline-marker-"+t);e&&e.remove()}(s),o.fadeOut(300,function(){t(this).remove(),0===t(".ytsubmission-comment-item").length&&t("#ytsubmission-comments-list").html('<p class="text-muted">No comments yet.</p>')})):i.alert("Error",e.message||"Failed to delete comment.","OK")}).fail(function(t){i.exception(t)})})}function _(){t("#ytsubmission-library-insert-btn").on("click",function(n){n.preventDefault(),function(){var n=t("#ytsubmission-library-panel");if(n.is(":visible"))return void n.slideUp(200);if(p)return D(p),void n.slideDown(200);e.call([{methodname:"assignsubmission_ytsubmission_get_library",args:{assignmentid:a,courseid:f}}])[0].done(function(t){p=t,D(t),n.slideDown(200)}).fail(function(t){i.exception(t)})}()}),t("#ytsubmission-library-save-btn").on("click",function(n){n.preventDefault(),function(){var n=E();if(!n.replace(/<[^>]*>/g,"").replace(/&nbsp;/g,"").trim())return void i.alert("Error","Please enter a comment to save.","OK");var s=t("#ytsubmission-commenttype").val()||"general",o='<div class="p-3">';o+="<p>Save this comment to:</p>",o+='<button class="btn btn-primary me-2 ytsubmission-save-scope" data-scope="personal">My Library</button>',f>0&&(o+='<button class="btn btn-outline-primary ytsubmission-save-scope" data-scope="course">Course Library</button>');var m=t('<div class="ytsubmission-save-scope-panel card p-2 mb-2">'+(o+="</div>")+"</div>");t("#ytsubmission-library-save-btn").after(m),m.find(".ytsubmission-save-scope").on("click",function(){var o="course"===t(this).data("scope")?f:0;m.remove(),e.call([{methodname:"assignsubmission_ytsubmission_save_library_comment",args:{assignmentid:a,commenttext:n,commenttype:s,courseid:o,itemid:0}}])[0].done(function(t){t.success&&(p=null,i.alert("Saved","Comment saved to library.","OK"))}).fail(function(t){i.exception(t)})}),setTimeout(function(){m.remove()},1e4)}()}),t(document).on("click",".ytsubmission-library-item-insert",function(e){e.preventDefault(),function(e,i){(function(e){if(window.tinymce){var i=window.tinymce.get("ytsubmission-comment-text");if(i)return void i.setContent(e)}t("#ytsubmission-comment-text").val(e)})(e),i&&t("#ytsubmission-commenttype").val(i);t("#ytsubmission-library-panel").slideUp(200)}(t(this).closest(".ytsubmission-library-item").data("commenttext"),t(this).closest(".ytsubmission-library-item").data("commenttype"))}),t(document).on("click",".ytsubmission-library-item-delete",function(n){n.preventDefault(),function(n){if(!confirm("Delete this library comment?"))return;var s=e.call([{methodname:"assignsubmission_ytsubmission_delete_library_comment",args:{assignmentid:a,itemid:n}}]);s[0].done(function(e){e.success&&(p=null,t('.ytsubmission-library-item[data-itemid="'+n+'"]').fadeOut(200,function(){t(this).remove()}))}).fail(function(t){i.exception(t)})}(parseInt(t(this).data("itemid"),10))}),t(document).on("click",".ytsubmission-library-filter",function(e){e.preventDefault();var i=t(this).data("filtertype");t(".ytsubmission-library-filter").removeClass("active"),t(this).addClass("active"),O(i)}),t(document).on("input","#ytsubmission-library-search",function(){var e=t(this).val().toLowerCase();O(t(".ytsubmission-library-filter.active").data("filtertype")||"all",e)}),t(document).on("click","#ytsubmission-library-close",function(e){e.preventDefault(),t("#ytsubmission-library-panel").slideUp(200)})}function D(e){var i='<div class="ytsubmission-library-inner p-3">';i+='<div class="d-flex justify-content-between align-items-center mb-3">',i+='<h5 class="mb-0">Comment Library</h5>',i+='<button id="ytsubmission-library-close" class="btn btn-sm btn-outline-secondary"><i class="fa fa-times"></i></button>',i+="</div>",i+='<input type="text" id="ytsubmission-library-search" class="form-control form-control-sm mb-2" placeholder="Search comments...">',i+='<div class="mb-3">',i+='<span class="badge bg-secondary ytsubmission-library-filter active me-1" data-filtertype="all" role="button">All</span>',Object.keys(b).forEach(function(t){var e=b[t];i+='<span class="badge ytsubmission-library-filter me-1" data-filtertype="'+t+'" role="button" style="background-color:'+e.color+';color:#fff;cursor:pointer;">'+e.label+"</span>"}),i+="</div>",i+='<div class="ytsubmission-library-section">',i+="<h6>My Comments</h6>",0===e.personal.length?i+='<p class="text-muted small">No personal comments saved.</p>':e.personal.forEach(function(t){i+=M(t,!0)}),i+="</div>",f>0&&(i+="<hr>",i+='<div class="ytsubmission-library-section">',i+="<h6>Course Comments</h6>",0===e.shared.length?i+='<p class="text-muted small">No shared comments yet.</p>':e.shared.forEach(function(t){i+=M(t,t.isowner)}),i+="</div>"),i+="</div>",t("#ytsubmission-library-panel").html(i)}function M(t,e){var i,n,s=t.commenttype||"general",o=b[s]||b.general||{label:"General",color:"#6c757d"},a=t.commenttext.replace(/<[^>]*>/g,"").substring(0,120),m='<div class="ytsubmission-library-item d-flex align-items-start p-2 mb-1" data-commenttext="'+(i=t.commenttext,(n=document.createElement("div")).appendChild(document.createTextNode(i)),n.innerHTML.replace(/"/g,"&quot;")+'" data-commenttype="')+s+'" data-itemid="'+t.id+'">';return m+='<span class="badge me-2" style="background-color:'+o.color+';color:#fff;min-width:75px;font-size:0.7em;">'+o.label+"</span>",m+='<span class="flex-grow-1 small ytsubmission-library-item-insert" role="button">'+a+"</span>",e&&(m+='<button class="btn btn-sm btn-outline-danger ms-2 ytsubmission-library-item-delete" data-itemid="'+t.id+'"><i class="fa fa-trash"></i></button>'),m+="</div>"}function O(e,i){i=i||t("#ytsubmission-library-search").val().toLowerCase(),t(".ytsubmission-library-item").each(function(){var n=t(this),s=n.data("commenttype"),o=n.text().toLowerCase(),a="all"===e||s===e,m=!i||-1!==o.indexOf(i);n.toggle(a&&m)})}return{init:function(e){s=e.videoId,o=e.submissionId,a=e.assignId,d=e.comments||[],b=e.commentTypes||{},y=!!e.readOnly,f=e.courseId||0,y||a?(m=document.getElementById("ytsubmission-current-time"),r=document.getElementById("ytsubmission-timestamp-input"),function(){if(!window.YT){var t=document.createElement("script");t.src="https://www.youtube.com/iframe_api";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}window.onYouTubeIframeAPIReady=function(){v()},window.YT&&window.YT.Player&&v()}(),t(document).on("click",".ytsubmission-timestamp-link",function(e){e.preventDefault();var i=parseInt(t(this).data("timestamp"),10);if(n&&"function"==typeof n.seekTo)try{n.seekTo(i,!0),n.playVideo()}catch(t){}}),y||(T(),I(),_())):i.alert("Error","Assignment ID missing. Cannot add comments.","OK")}}});